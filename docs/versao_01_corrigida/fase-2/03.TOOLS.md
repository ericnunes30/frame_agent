# Design e Implementação de Tools

## Interface de Tool Padrão

### Estrutura Básica

```typescript
interface Tool {
  name: string;
  description: string;
  parameters?: ToolParameters;
  execute: (args: any) => Promise<any>;
}

interface ToolParameters {
  type: 'object';
  properties: Record<string, ToolParameter>;
  required?: string[];
}

interface ToolParameter {
  type: 'string' | 'number' | 'boolean' | 'array' | 'object';
  description: string;
  enum?: any[];
  items?: ToolParameter; // Para arrays
  properties?: Record<string, ToolParameter>; // Para objetos
}
```

### Exemplos de Tools

#### 1. Calculadora Simples

```typescript
const calculatorTool: Tool = {
  name: "calculate",
  description: "Realiza operações matemáticas básicas",
  parameters: {
    type: "object",
    properties: {
      expression: {
        type: "string",
        description: "Expressão matemática para calcular (ex: '2 + 2 * 3')"
      }
    },
    required: ["expression"]
  },
  execute: async (args: { expression: string }) => {
    try {
      // Implementação segura de cálculo
      const result = eval(args.expression); // Em produção, usar parser seguro
      return { result: Number(result.toFixed(2)) };
    } catch (error) {
      throw new Error(`Não foi possível calcular: ${args.expression}`);
    }
  }
};
```

#### 2. Data e Hora Atual

```typescript
const dateTimeTool: Tool = {
  name: "get_current_datetime",
  description: "Obtém a data e hora atual",
  parameters: {
    type: "object",
    properties: {
      timezone: {
        type: "string",
        description: "Fuso horário (ex: 'America/Sao_Paulo')"
      }
    }
  },
  execute: async (args: { timezone?: string }) => {
    const now = new Date();
    return {
      datetime: now.toISOString(),
      date: now.toISOString().split('T')[0],
      time: now.toTimeString().split(' ')[0],
      timezone: args.timezone || 'UTC'
    };
  }
};
```

#### 3. Consulta de Clima (Simulada)

```typescript
const weatherTool: Tool = {
  name: "get_weather",
  description: "Obtém informações sobre o clima para uma localização",
  parameters: {
    type: "object",
    properties: {
      location: {
        type: "string",
        description: "Nome da cidade ou localização"
      }
    },
    required: ["location"]
  },
  execute: async (args: { location: string }) => {
    // Simulação - em produção, integrar com API real
    const conditions = ["Ensolarado", "Nublado", "Chuvoso", "Parcialmente nublado"];
    const condition = conditions[Math.floor(Math.random() * conditions.length)];
    const temperature = Math.floor(Math.random() * 30) + 10; // 10-40°C
    
    return {
      location: args.location,
      condition: condition,
      temperature: temperature,
      unit: "Celsius"
    };
  }
};
```

## Registro e Gerenciamento de Tools

### Sistema de Registro

```typescript
class ToolRegistry {
  private tools: Map<string, Tool> = new Map();
  
  register(tool: Tool): void {
    if (this.tools.has(tool.name)) {
      throw new Error(`Tool '${tool.name}' já registrada`);
    }
    this.tools.set(tool.name, tool);
  }
  
  unregister(name: string): boolean {
    return this.tools.delete(name);
  }
  
  get(name: string): Tool | undefined {
    return this.tools.get(name);
  }
  
  list(): Tool[] {
    return Array.from(this.tools.values());
  }
  
  has(name: string): boolean {
    return this.tools.has(name);
  }
  
  clear(): void {
    this.tools.clear();
  }
}
```

### Integração com o Agente

```typescript
class ChatAgent {
  private toolRegistry: ToolRegistry = new ToolRegistry();
  
  registerTool(tool: Tool): void {
    this.toolRegistry.register(tool);
  }
  
  unregisterTool(name: string): boolean {
    return this.toolRegistry.unregister(name);
  }
  
  listTools(): Tool[] {
    return this.toolRegistry.list();
  }
  
  async executeTool(toolName: string, args: any): Promise<any> {
    const tool = this.toolRegistry.get(toolName);
    if (!tool) {
      throw new Error(`Tool '${toolName}' não encontrada`);
    }
    
    try {
      // Validar parâmetros se disponíveis
      if (tool.parameters) {
        this.validateParameters(tool.parameters, args);
      }
      
      // Executar tool com timeout
      const timeout = 30000; // 30 segundos
      const result = await Promise.race([
        tool.execute(args),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout na execução da tool')), timeout)
        )
      ]);
      
      return result;
    } catch (error) {
      throw new Error(`Erro ao executar tool '${toolName}': ${error.message}`);
    }
  }
  
  private validateParameters(schema: ToolParameters, args: any): void {
    // Implementação de validação de parâmetros
    // Pode usar Zod, Joi, ou validação customizada
  }
}
```

## Integração com BAML

### Definição de Tools no BAML

```baml
// tools.baml

// Schema para parâmetros da calculadora
class CalculatorParams {
  expression string
}

function Calculate(params: CalculatorParams) -> string {
  client OpenAIGPT4oMini
  prompt #"
    Avalie a expressão matemática e retorne apenas o resultado numérico.
    
    Expressão: {{ params.expression }}
    
    Retorne apenas o resultado numérico, nada mais.
  "#
}

// Schema para parâmetros de data/hora
class DateTimeParams {
  timezone string?
}

function GetCurrentDateTime(params: DateTimeParams) -> string {
  client OpenAIGPT4oMini
  prompt #"
    Retorne a data e hora atual no formato: "YYYY-MM-DD HH:MM:SS"
    {% if params.timezone %}
    No fuso horário: {{ params.timezone }}
    {% endif %}
  "#
}

// Schema para parâmetros de clima
class WeatherParams {
  location string
}

function GetWeather(params: WeatherParams) -> string {
  client OpenAIGPT4oMini
  prompt #"
    Forneça uma descrição do clima para a localização: {{ params.location }}
    
    Retorne uma descrição simples como:
    "Ensolarado, 25°C"
    "Chuvoso, 18°C"
    "Nublado, 22°C"
  "#
}
```

### Registro Automático de Tools BAML

```typescript
// Função para registrar tools BAML automaticamente
async function registerBAMLTools(agent: ChatAgent): Promise<void> {
  // Registrar tools BAML disponíveis
  agent.registerTool({
    name: "calculate",
    description: "Realiza operações matemáticas básicas",
    parameters: {
      type: "object",
      properties: {
        expression: {
          type: "string",
          description: "Expressão matemática para calcular"
        }
      },
      required: ["expression"]
    },
    execute: async (args: { expression: string }) => {
      return await b.Calculate({ expression: args.expression });
    }
  });
  
  agent.registerTool({
    name: "get_current_datetime",
    description: "Obtém a data e hora atual",
    parameters: {
      type: "object",
      properties: {
        timezone: {
          type: "string",
          description: "Fuso horário (opcional)"
        }
      }
    },
    execute: async (args: { timezone?: string }) => {
      return await b.GetCurrentDateTime({ timezone: args.timezone });
    }
  });
  
  agent.registerTool({
    name: "get_weather",
    description: "Obtém informações sobre o clima",
    parameters: {
      type: "object",
      properties: {
        location: {
          type: "string",
          description: "Localização para consulta do clima"
        }
      },
      required: ["location"]
    },
    execute: async (args: { location: string }) => {
      return await b.GetWeather({ location: args.location });
    }
  });
}
```

## Tratamento de Erros em Tools

### Estratégias de Tratamento

```typescript
class ToolError extends Error {
  constructor(
    message: string,
    public toolName: string,
    public originalError?: Error
  ) {
    super(message);
    this.name = 'ToolError';
  }
}

class ToolExecutor {
  async executeWithRetry(
    tool: Tool,
    args: any,
    maxRetries: number = 3
  ): Promise<any> {
    let lastError: Error;
    
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
      try {
        return await tool.execute(args);
      } catch (error) {
        lastError = error;
        
        if (attempt < maxRetries) {
          // Esperar antes de retry (exponencial backoff)
          const delay = Math.pow(2, attempt) * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }
    
    throw new ToolError(
      `Falha após ${maxRetries + 1} tentativas: ${lastError.message}`,
      tool.name,
      lastError
    );
  }
}
```

## Boas Práticas para Tools

### 1. Segurança
- Validar todos os parâmetros de entrada
- Implementar timeouts para evitar travamentos
- Limitar recursos (memória, CPU) por tool
- Sanitizar dados de saída

### 2. Performance
- Cache resultados quando apropriado
- Executar tools independentes em paralelo
- Monitorar tempo de execução
- Implementar fallback para tools críticas

### 3. Observabilidade
- Logging detalhado de execuções
- Métricas de uso e performance
- Tracing de chamadas
- Alertas para falhas recorrentes

### 4. Manutenibilidade
- Documentação clara de cada tool
- Testes unitários abrangentes
- Versionamento de interfaces
- Compatibilidade retroativa

## Próximos Passos

1. Implementar sistema básico de tools
2. Criar tools de exemplo (calculadora, data/hora, clima)
3. Integrar com BAML para tools tipadas
4. Implementar tratamento de erros robusto
5. Criar testes para tools e registro
6. Documentar padrões de implementação